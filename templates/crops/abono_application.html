{% extends "base.html" %}
{% block content %}
<h2>Registrar aplicación de abono para {{ crop.name }}</h2>
{% if form %}
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button class="btn" type="submit">Registrar abono</button>
</form>
{% endif %}

<h3>Historial de aplicaciones de abono</h3>
<table class="table">
  <thead>
    <tr><th>Fecha programada</th><th>Tip de abono</th><th>Estado</th><th>Acciones</th></tr>
  </thead>
  <tbody>
    {% for ab in abonos %}
      <tr>
        <td>{{ ab.scheduled_date|date:"Y-m-d" }}</td>
        <td>{{ ab.tip|default:"-" }}</td>
        <td>
          {% if ab.status == "pendiente" %}
            <span style="color: gray;">Pendiente</span>
          {% elif ab.status == "aplicado" %}
            <span style="color: green;">Aplicado</span>
          {% elif ab.status == "no_aplicado" %}
            <span style="color: red;">No Aplicado</span>
          {% endif %}
        </td>
        <td>
          {% if ab.status == "pendiente" and ab.scheduled_date <= today %}
            <form method="post" action="{% url 'update_abono_status' ab.id 'aplicado' %}">
              {% csrf_token %}
              <button class="btn btn-success">Aplicar</button>
            </form>
            <form method="post" action="{% url 'update_abono_status' ab.id 'no_aplicado' %}">
              {% csrf_token %}
              <button class="btn btn-danger">No Aplicar</button>
            </form>
          {% else %}
            <button class="btn" disabled>Acción no disponible</button>
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="3">Sin aplicaciones registradas.</td></tr>
    {% endfor %}
  </tbody>
</table>
<a href="{% url 'dashboard' %}" class="btn">Volver al dashboard</a>
{% endblock %}
